<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="refresh" content="300">
<title>Vertriebsübersicht (Debug-Version)</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
/* —— CSS unchanged —— */
:root{
 --c-green:#029c46;--c-lime:#a7e80d;--c-pink:#d51ae6;
 --c-label:#868E99;--c-grid:#d0d5dd;--c-text:#0d1117;
 font-family:system-ui,Roboto,Helvetica,Arial,sans-serif;
}
body{margin:0;padding:2rem}
#c{max-width:600px;margin:auto}
</style>
</head>
<body>
<canvas id="c" height="350"></canvas>

<script>
/* ----------------- ❶ raw JSON exactly as posted ---------------- */
const rawJson=[{
  "Total today":0,"Kategorie_AH":0,"Kategorie_HD":0,"Kategorie_BB":0,
  "Kategorie_O":0,"Kategorie_W":0,
  "Total_4":4,"AH_4":0,"HD_4":0,"BB_4":4,"O_4":0,"W_4":0,
  "Total_3":3,"AH_3":0,"HD_3":2,"BB_3":1,"O_3":0,"W_3":0,
  "Total_2":0,"AH_2":0,"HD_2":0,"BB_2":0,"O_2":0,"W_2":0,
  "Total_1":0,"AH_1":0,"HD_1":0,"BB_1":0,"O_1":0,"W_1":0
}][0];
console.log('① raw JSON');console.log(rawJson);

/* ----------------- ❷ convert to array newest→oldest ------------ */
const offsets=[0,1,2,3,4];          // 0 = today, 4 = four days ago
const newestFirst=offsets.map(o=>[
  rawJson[`BB_${o}`]??0,            // Barrierefrei
  rawJson[`HD_${o}`]??0,            // HMS
  rawJson[`AH_${o}`]??0             // AH
]);
console.log('② newest-first from sheet');console.table(newestFirst);

/* ----------------- ❸ create work-day list oldest→newest -------- */
function getLastWorkdays(n){
  const res=[];let d=new Date();
  while(res.length<n){
    const wd=d.getDay();            // 0 Sun … 6 Sat
    if(wd!==0&&wd!==6) res.push(new Date(d));
    d.setDate(d.getDate()-1);
  }
  return res.reverse();             // chronological
}
const workdays=getLastWorkdays(5);
console.log('③ work-days (chronological)');console.table(
  workdays.map(d=>d.toDateString()));

/* ----------------- ❹ flip values so both arrays have same order */
const valsChrono = newestFirst.slice().reverse();
console.log('④ values in chronological order');console.table(valsChrono);

/* ----------------- ❺ tie them together for the chart ----------- */
const daysDe=['So','Mo','Di','Mi','Do','Fr','Sa'];
const fmt=new Intl.DateTimeFormat('de-DE',{day:'2-digit',month:'2-digit'});
const bars=workdays.map((d,i)=>({
  label:`${daysDe[d.getDay()]} ${fmt.format(d)}.`,
  vals : valsChrono[i]
}));
console.log('⑤ final bars');console.table(bars);

/* ----------------- ❻ draw the stacked bar chart ---------------- */
const ctx=document.getElementById('c');
new Chart(ctx,{
  type:'bar',
  data:{
    labels:bars.map(b=>b.label),
    datasets:[
      {label:'Barrierefrei',data:bars.map(b=>b.vals[0]),backgroundColor:getCss('--c-green')},
      {label:'HMS',         data:bars.map(b=>b.vals[1]),backgroundColor:getCss('--c-lime')},
      {label:'AH',          data:bars.map(b=>b.vals[2]),backgroundColor:getCss('--c-pink')}
    ]
  },
  options:{
    scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}},
    plugins:{legend:{position:'bottom'},datalabels:{display:false}}
  }
});

/* helper to read CSS custom props */
function getCss(v){return getComputedStyle(document.documentElement)
                   .getPropertyValue(v).trim();}
</script>
</body>
</html>
